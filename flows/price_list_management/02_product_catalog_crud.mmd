---
config:
  theme: dark
  themeVariables:
    primaryColor: '#E3F2FD'
    primaryTextColor: '#0D47A1'
    primaryBorderColor: '#2196F3'
    lineColor: '#1976D2'
    secondaryColor: '#F3E5F5'
    tertiaryColor: '#FFF3E0'
    noteBkgColor: '#FFFDE7'
    noteBorderColor: '#FBC02D'
  layout: elk
---
flowchart TB
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% DEMETERDOCS - PRODUCT CATALOG CRUD OPERATIONS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% Purpose: Detailed implementation of product catalog hierarchy management
    %% Scope: Complete CRUD for Categories â†’ Families â†’ Products
    %% Detail: Database operations, validation, hierarchical relationships
    %% Updated: 2025-10-08 | Version: 1.0 | Mermaid v11.3.0+
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ENTRY POINT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    START@{ shape: stadium, label: "ğŸŒµ Admin: Manage
    Product Catalog
    Role: admin only" }

    SELECT_LEVEL@{ shape: diamond, label: "Catalog Level?" }

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CATEGORY MANAGEMENT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph CATEGORY_FLOW["ğŸ“ CATEGORY MANAGEMENT (Level 1)"]
        direction TB

        CAT_ACTION@{ shape: diamond, label: "CRUD Operation?" }

        CAT_CREATE@{ shape: rect, label: "â• Create Category
        Input:
        â€¢ Code (4 chars, uppercase)
        â€¢ Name
        â€¢ Description
        â€¢ Display order

        Examples:
        CACT - Cactus
        SUCC - Suculenta
        INJT - Injerto" }

        CAT_VALIDATE@{ shape: rect, label: "âœ… Validate
        â€¢ Code: uppercase, max 4
        â€¢ Code unique
        â€¢ Name required" }

        CAT_SAVE@{ shape: cyl, label: "ğŸ’¾ Insert Category
        INSERT INTO
        product_categories
        VALUES (...)
        RETURNING id

        â±ï¸ 30ms" }

        CAT_LIST@{ shape: cyl, label: "ğŸ“‹ List Categories
        SELECT
        pc.*,
        COUNT(pf.id) as families,
        COUNT(p.id) as products
        FROM product_categories
        GROUP BY pc.id

        â±ï¸ 50ms" }

        CAT_UPDATE@{ shape: rect, label: "âœï¸ Update Category
        Modify:
        â€¢ Name
        â€¢ Description
        â€¢ Display order
        Note: Code immutable" }

        CAT_DELETE_CHECK@{ shape: cyl, label: "ğŸ” Check References
        SELECT COUNT(*)
        FROM product_families
        WHERE category_id = $1

        â±ï¸ 20ms" }

        CAT_HAS_FAMILIES@{ shape: diamond, label: "Has Families?" }

        CAT_DELETE_BLOCKED@{ shape: rect, label: "ğŸš« Cannot Delete
        409 Conflict:
        Category has X families
        Delete families first" }

        CAT_DELETE@{ shape: cyl, label: "ğŸ’¥ Delete Category
        DELETE FROM
        product_categories
        WHERE id = $1

        â±ï¸ 30ms" }
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% FAMILY MANAGEMENT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph FAMILY_FLOW["ğŸ“‚ FAMILY MANAGEMENT (Level 2)"]
        direction TB

        FAM_ACTION@{ shape: diamond, label: "CRUD Operation?" }

        FAM_SELECT_CAT@{ shape: rect, label: "ğŸ¯ Select Category
        Choose parent category:
        â€¢ Cactus
        â€¢ Suculenta
        â€¢ Injerto" }

        FAM_CREATE@{ shape: rect, label: "â• Create Family
        Input:
        â€¢ Category (parent)
        â€¢ Name
        â€¢ Scientific name
        â€¢ Description

        Example:
        Cactus â†’ EsfÃ©ricos
        Cactus â†’ Columnares" }

        FAM_VALIDATE@{ shape: rect, label: "âœ… Validate
        â€¢ Category exists
        â€¢ Name unique in category
        â€¢ Required fields present" }

        FAM_CHECK_DUP@{ shape: cyl, label: "Check Duplicate
        SELECT * FROM
        product_families
        WHERE category_id = $1
        AND name = $2

        â±ï¸ 30ms" }

        FAM_DUPLICATE@{ shape: diamond, label: "Duplicate?" }

        FAM_ERROR@{ shape: rect, label: "âŒ Error
        409 Conflict:
        Family name already
        exists in this category" }

        FAM_SAVE@{ shape: cyl, label: "ğŸ’¾ Insert Family
        INSERT INTO
        product_families
        VALUES (...)
        RETURNING id

        â±ï¸ 30ms" }

        FAM_LIST@{ shape: cyl, label: "ğŸ“‹ List Families
        SELECT
        pf.*,
        pc.name as category,
        COUNT(p.id) as products
        FROM product_families pf
        JOIN product_categories pc
        LEFT JOIN products p
        WHERE category_id = $1
        GROUP BY pf.id

        â±ï¸ 80ms" }

        FAM_UPDATE@{ shape: rect, label: "âœï¸ Update Family
        Modify:
        â€¢ Name
        â€¢ Scientific name
        â€¢ Description
        Note: Cannot change category" }

        FAM_DELETE_CHECK@{ shape: cyl, label: "ğŸ” Check Products
        SELECT COUNT(*)
        FROM products
        WHERE family_id = $1

        â±ï¸ 20ms" }

        FAM_HAS_PRODUCTS@{ shape: diamond, label: "Has Products?" }

        FAM_DELETE_BLOCKED@{ shape: rect, label: "ğŸš« Cannot Delete
        409 Conflict:
        Family has X products
        Delete products first" }

        FAM_DELETE@{ shape: cyl, label: "ğŸ’¥ Delete Family
        DELETE FROM
        product_families
        WHERE id = $1

        â±ï¸ 30ms" }
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PRODUCT MANAGEMENT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph PRODUCT_FLOW["ğŸŒ± PRODUCT MANAGEMENT (Level 3)"]
        direction TB

        PROD_ACTION@{ shape: diamond, label: "CRUD Operation?" }

        PROD_SELECT_FAM@{ shape: rect, label: "ğŸ¯ Select Family
        Navigate hierarchy:
        Category â†’ Family

        Example:
        Cactus â†’ EsfÃ©ricos" }

        PROD_CREATE@{ shape: rect, label: "â• Create Product
        Input:
        â€¢ Family (parent)
        â€¢ SKU (unique)
        â€¢ Common name
        â€¢ Scientific name
        â€¢ Description
        â€¢ Temperature range
        â€¢ Sunlight requirement
        â€¢ Watering frequency" }

        PROD_VALIDATE@{ shape: rect, label: "âœ… Validate
        â€¢ Family exists
        â€¢ SKU unique
        â€¢ Temperature range valid
        â€¢ Enums valid
        â€¢ Required fields" }

        PROD_CHECK_SKU@{ shape: cyl, label: "Check SKU
        SELECT * FROM products
        WHERE sku = $1

        â±ï¸ 20ms" }

        PROD_SKU_EXISTS@{ shape: diamond, label: "SKU Exists?" }

        PROD_SKU_ERROR@{ shape: rect, label: "âŒ Error
        409 Conflict:
        SKU already exists

        SKU must be globally
        unique" }

        PROD_VALIDATE_TEMP@{ shape: rect, label: "ğŸŒ¡ï¸ Validate Temps
        Check:
        min_temp <= max_temp

        If both provided" }

        PROD_VALIDATE_ENUMS@{ shape: rect, label: "ğŸ” Validate Enums
        Sunlight:
        full_sun | partial_shade | shade

        Watering:
        high | medium | low" }

        PROD_SAVE@{ shape: cyl, label: "ğŸ’¾ Insert Product
        INSERT INTO products
        VALUES (...)
        RETURNING id

        â±ï¸ 40ms" }

        PROD_LIST@{ shape: cyl, label: "ğŸ“‹ List Products
        SELECT
        p.*,
        pf.name as family,
        pc.name as category
        FROM products p
        JOIN product_families pf
        JOIN product_categories pc
        WHERE (filters)
        ORDER BY category, family, name
        LIMIT 50 OFFSET $n

        â±ï¸ 150ms" }

        PROD_UPDATE@{ shape: rect, label: "âœï¸ Update Product
        Modify:
        â€¢ Names
        â€¢ Description
        â€¢ Care requirements
        Note: SKU, family immutable" }

        PROD_DELETE_CHECK@{ shape: cyl, label: "ğŸ” Check Usage
        SELECT COUNT(*)
        FROM storage_location_config
        WHERE product_id = $1

        Check if used in configs

        â±ï¸ 30ms" }

        PROD_IN_USE@{ shape: diamond, label: "In Use?" }

        PROD_DELETE_BLOCKED@{ shape: rect, label: "ğŸš« Cannot Delete
        409 Conflict:
        Product used in:
        â€¢ X storage configs

        Remove references first" }

        PROD_DELETE@{ shape: cyl, label: "ğŸ’¥ Delete Product
        DELETE FROM products
        WHERE id = $1

        â±ï¸ 30ms" }
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% SHARED COMPONENTS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    AUDIT@{ shape: rect, label: "ğŸ“‹ Audit Log
    Record:
    â€¢ User ID
    â€¢ Action
    â€¢ Entity type & ID
    â€¢ Changes
    â€¢ Timestamp" }

    CACHE_CLEAR@{ shape: rect, label: "ğŸ—‘ï¸ Invalidate Cache
    Clear:
    â€¢ Catalog hierarchy
    â€¢ Category lists
    â€¢ Family lists
    â€¢ Product lists" }

    SUCCESS@{ shape: rect, label: "âœ… Success Response
    Return created/updated
    entity with full
    hierarchy info" }

    END_STATE@{ shape: stadium, label: "ğŸ Operation Complete
    Return to catalog view" }

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNECTIONS - MAIN FLOW
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    START --> SELECT_LEVEL

    SELECT_LEVEL -->|Categories| CAT_ACTION
    SELECT_LEVEL -->|Families| FAM_SELECT_CAT
    SELECT_LEVEL -->|Products| PROD_SELECT_FAM

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNECTIONS - CATEGORY FLOW
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    CAT_ACTION -->|Create| CAT_CREATE
    CAT_ACTION -->|List| CAT_LIST
    CAT_ACTION -->|Update| CAT_UPDATE
    CAT_ACTION -->|Delete| CAT_DELETE_CHECK

    CAT_CREATE --> CAT_VALIDATE
    CAT_VALIDATE --> CAT_SAVE
    CAT_SAVE --> AUDIT

    CAT_LIST --> SUCCESS

    CAT_UPDATE --> CAT_VALIDATE

    CAT_DELETE_CHECK --> CAT_HAS_FAMILIES
    CAT_HAS_FAMILIES -->|Yes| CAT_DELETE_BLOCKED
    CAT_HAS_FAMILIES -->|No| CAT_DELETE
    CAT_DELETE_BLOCKED --> END_STATE
    CAT_DELETE --> AUDIT

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNECTIONS - FAMILY FLOW
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    FAM_SELECT_CAT --> FAM_ACTION

    FAM_ACTION -->|Create| FAM_CREATE
    FAM_ACTION -->|List| FAM_LIST
    FAM_ACTION -->|Update| FAM_UPDATE
    FAM_ACTION -->|Delete| FAM_DELETE_CHECK

    FAM_CREATE --> FAM_VALIDATE
    FAM_VALIDATE --> FAM_CHECK_DUP
    FAM_CHECK_DUP --> FAM_DUPLICATE

    FAM_DUPLICATE -->|Yes| FAM_ERROR
    FAM_DUPLICATE -->|No| FAM_SAVE

    FAM_ERROR --> FAM_CREATE
    FAM_SAVE --> AUDIT

    FAM_LIST --> SUCCESS

    FAM_UPDATE --> FAM_VALIDATE

    FAM_DELETE_CHECK --> FAM_HAS_PRODUCTS
    FAM_HAS_PRODUCTS -->|Yes| FAM_DELETE_BLOCKED
    FAM_HAS_PRODUCTS -->|No| FAM_DELETE
    FAM_DELETE_BLOCKED --> END_STATE
    FAM_DELETE --> AUDIT

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNECTIONS - PRODUCT FLOW
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    PROD_SELECT_FAM --> PROD_ACTION

    PROD_ACTION -->|Create| PROD_CREATE
    PROD_ACTION -->|List| PROD_LIST
    PROD_ACTION -->|Update| PROD_UPDATE
    PROD_ACTION -->|Delete| PROD_DELETE_CHECK

    PROD_CREATE --> PROD_VALIDATE
    PROD_VALIDATE --> PROD_CHECK_SKU
    PROD_CHECK_SKU --> PROD_SKU_EXISTS

    PROD_SKU_EXISTS -->|Yes| PROD_SKU_ERROR
    PROD_SKU_EXISTS -->|No| PROD_VALIDATE_TEMP

    PROD_SKU_ERROR --> PROD_CREATE

    PROD_VALIDATE_TEMP --> PROD_VALIDATE_ENUMS
    PROD_VALIDATE_ENUMS --> PROD_SAVE
    PROD_SAVE --> AUDIT

    PROD_LIST --> SUCCESS

    PROD_UPDATE --> PROD_VALIDATE

    PROD_DELETE_CHECK --> PROD_IN_USE
    PROD_IN_USE -->|Yes| PROD_DELETE_BLOCKED
    PROD_IN_USE -->|No| PROD_DELETE
    PROD_DELETE_BLOCKED --> END_STATE
    PROD_DELETE --> AUDIT

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNECTIONS - SHARED COMPONENTS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    AUDIT --> CACHE_CLEAR
    CACHE_CLEAR --> SUCCESS
    SUCCESS --> END_STATE

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLING
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    classDef categoryStyle fill:#E3F2FD,stroke:#1565C0,stroke-width:2px
    classDef familyStyle fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    classDef productStyle fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px
    classDef errorStyle fill:#FFCDD2,stroke:#B71C1C,stroke-width:3px
    classDef successStyle fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    classDef sharedStyle fill:#FFF3E0,stroke:#EF6C00,stroke-width:2px

    class CAT_ACTION,CAT_CREATE,CAT_VALIDATE,CAT_SAVE,CAT_LIST,CAT_UPDATE,CAT_DELETE_CHECK,CAT_DELETE categoryStyle
    class CAT_DELETE_BLOCKED,FAM_ERROR,FAM_DELETE_BLOCKED,PROD_SKU_ERROR,PROD_DELETE_BLOCKED errorStyle

    class FAM_SELECT_CAT,FAM_ACTION,FAM_CREATE,FAM_VALIDATE,FAM_CHECK_DUP,FAM_SAVE,FAM_LIST,FAM_UPDATE,FAM_DELETE_CHECK,FAM_DELETE familyStyle

    class PROD_SELECT_FAM,PROD_ACTION,PROD_CREATE,PROD_VALIDATE,PROD_CHECK_SKU,PROD_VALIDATE_TEMP,PROD_VALIDATE_ENUMS,PROD_SAVE,PROD_LIST,PROD_UPDATE,PROD_DELETE_CHECK,PROD_DELETE productStyle

    class AUDIT,CACHE_CLEAR sharedStyle
    class SUCCESS successStyle
