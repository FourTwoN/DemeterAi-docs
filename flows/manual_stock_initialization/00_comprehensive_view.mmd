---
config:
  theme: redux-dark-color
  layout: elk
---
flowchart TD
%% ============================================================================
%% MANUAL STOCK INITIALIZATION - COMPREHENSIVE VIEW
%% ============================================================================
    START@{ shape: stadium, label: "ðŸš€ User Initiates
Manual Stock Count

Location: Storage Location Page
â±ï¸ ~0ms" }

FORM@{ shape: rect, label: "ðŸ“ Fill Form
- Storage Location
- Product
- Packaging
- Quantity
- (Optional) Size, Notes

â±ï¸ ~10ms validation" }

SUBMIT@{ shape: rect, label: "ðŸ“¤ POST /api/stock/manual
{
location_id: 123,
product_id: 45,
packaging_id: 12,
quantity: 1500
}

â±ï¸ ~20ms" }

API_VALIDATE@{ shape: rect, label: "âœ… API Validation
Pydantic Schema:
- Required fields present
- Quantity > 0
- Valid IDs

â±ï¸ ~20ms" }

CHECK_LOCATION@{ shape: cyl, label: "ðŸ—„ï¸ Query storage_location
SELECT * FROM storage_locations
WHERE id = ?

â±ï¸ ~15ms" }

LOCATION_EXISTS@{ shape: diamond, label: "Location
Found?" }

GET_CONFIG@{ shape: cyl, label: "ðŸ—„ï¸ Query storage_location_config
SELECT * FROM storage_location_config
WHERE storage_location_id = ?

â±ï¸ ~20ms" }

CONFIG_EXISTS@{ shape: diamond, label: "Configuration
Exists?" }

VALIDATE_PRODUCT@{ shape: diamond, label: "ðŸ” CRITICAL CHECK
config.product_id ==
request.product_id?" }

VALIDATE_PACKAGING@{ shape: diamond, label: "ðŸ” CRITICAL CHECK
config.packaging_id ==
request.packaging_id?" }

CREATE_MOVEMENT@{ shape: subproc, label: "ðŸ’¾ Create stock_movement
- movement_type: 'manual_init'
- source_type: 'manual'
- quantity: user input
- user_id: current user
- processing_session_id: NULL

â±ï¸ ~50ms" }

CREATE_BATCH@{ shape: subproc, label: "ðŸ’¾ Create stock_batch
- batch_code: LOC-PROD-DATE-SEQ
- quantity_initial: user input
- quantity_current: user input
- quality_score: NULL (no ML)

â±ï¸ ~50ms" }

COMMIT@{ shape: cyl, label: "ðŸ—„ï¸ COMMIT Transaction

â±ï¸ ~30ms" }

SUCCESS@{ shape: stadium, label: "âœ… HTTP 201 Created
{
stock_movement_id,
stock_batch_id,
message: 'Success'
}

â±ï¸ ~10ms" }

%% Error nodes
ERROR_LOCATION@{ shape: stadium, label: "âŒ HTTP 404
StorageLocationNotFound

User Action: Verify location" }

ERROR_PRODUCT@{ shape: stadium, label: "âŒ HTTP 400
ProductMismatchException

Expected: Echeveria Golden
Got: Sedum Blue

User Action: Update config
or re-enter correct product" }

ERROR_PACKAGING@{ shape: stadium, label: "âŒ HTTP 400
PackagingMismatchException

Expected: R7 pot
Got: R10 pot

User Action: Update config
or re-enter correct packaging" }

ERROR_VALIDATION@{ shape: stadium, label: "âŒ HTTP 422
ValidationError

Examples:
- Quantity â‰¤ 0
- Missing required fields

User Action: Fix form" }

CREATE_CONFIG@{ shape: rect, label: "ðŸ†• (Optional) Create Config
storage_location_config:
- product_id: user input
- packaging_id: user input
- notes: 'Auto-created'

â±ï¸ ~30ms" }

%% Flow connections
START --> FORM
FORM --> SUBMIT
SUBMIT --> API_VALIDATE

API_VALIDATE -->|âœ… Valid|CHECK_LOCATION
API_VALIDATE -->|âŒ Invalid|ERROR_VALIDATION

CHECK_LOCATION --> LOCATION_EXISTS

LOCATION_EXISTS -->|âŒ No|ERROR_LOCATION
LOCATION_EXISTS -->|âœ… Yes|GET_CONFIG

GET_CONFIG --> CONFIG_EXISTS

CONFIG_EXISTS -->|âŒ No|CREATE_CONFIG
CONFIG_EXISTS -->|âœ… Yes|VALIDATE_PRODUCT

CREATE_CONFIG --> CREATE_MOVEMENT

VALIDATE_PRODUCT -->|âŒ Mismatch|ERROR_PRODUCT
VALIDATE_PRODUCT -->|âœ… Match|VALIDATE_PACKAGING

VALIDATE_PACKAGING -->|âŒ Mismatch|ERROR_PACKAGING
VALIDATE_PACKAGING -->|âœ… Match|CREATE_MOVEMENT

CREATE_MOVEMENT --> CREATE_BATCH
CREATE_BATCH --> COMMIT
COMMIT --> SUCCESS

%% Styling
classDef successClass fill: #2e7d32, stroke: #1b5e20, color: #fff
classDef errorClass fill: #c62828, stroke: #b71c1c, color: #fff
classDef criticalClass fill: #f57c00, stroke: #e65100, color: #fff
classDef dbClass fill: #1565c0, stroke: #0d47a1, color: #fff

class SUCCESS successClass
class ERROR_LOCATION, ERROR_PRODUCT,ERROR_PACKAGING, ERROR_VALIDATION errorClass
class VALIDATE_PRODUCT,VALIDATE_PACKAGING criticalClass
class CHECK_LOCATION, GET_CONFIG,COMMIT dbClass
