# Alembic Database Migrations - DemeterAI v2.0

## Overview

DemeterAI uses Alembic for database schema migrations. This document provides guidance on using
Alembic for database evolution throughout the development lifecycle.

## Setup Complete (F007)

The following components have been configured:

1. **Alembic initialized** (`alembic init alembic`)
    - Directory: `/alembic/`
    - Config file: `/alembic.ini`
    - Environment: `/alembic/env.py`
    - Versions: `/alembic/versions/`

2. **Base declarative class** (`app/db/base.py`)
    - SQLAlchemy declarative base
    - Model import location for Alembic autogenerate

3. **Initial migration** (Revision: 6f1b94ebef45)
    - Enables PostGIS extension
    - Required for geospatial functionality

## Configuration

### Database Connection

Alembic uses `DATABASE_URL_SYNC` from `app.core.config.settings`:

```python
# .env file
DATABASE_URL_SYNC=postgresql+psycopg2://demeter:password@localhost:5432/demeterai
```

**Important**:

- Application uses `asyncpg` (async driver)
- Alembic uses `psycopg2` (sync driver) - migrations are synchronous
- Both connect to the same database with different drivers

### Environment Configuration

The `alembic/env.py` file:

- Imports `Base.metadata` from `app.db.base`
- Overrides `sqlalchemy.url` from settings
- Supports both online and offline modes
- Detects column type and server default changes

## Common Commands

### View Migration Status

```bash
# Show current migration revision (requires DB connection)
alembic current

# Show all migrations
alembic history

# Show details of a specific migration
alembic show 6f1b94ebef45

# Show migration branches
alembic branches
```

### Create Migrations

```bash
# Create a new migration (manual)
alembic revision -m "add new table"

# Create migration with autogenerate (detects model changes)
alembic revision --autogenerate -m "add warehouse model"
```

**IMPORTANT**: Always review autogenerated migrations before applying.
Alembic may miss:

- Check constraints
- Server defaults
- Custom indexes
- Enum types
- PostGIS spatial indexes

### Apply Migrations

```bash
# Apply all pending migrations
alembic upgrade head

# Apply specific number of migrations
alembic upgrade +1

# Apply to specific revision
alembic upgrade 6f1b94ebef45

# Generate SQL without executing (offline mode)
alembic upgrade head --sql > migration.sql
```

### Rollback Migrations

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade 6f1b94ebef45

# Rollback all migrations
alembic downgrade base
```

## Workflow for Adding New Models

When creating SQLAlchemy models (DB001-DB035), follow this workflow:

### 1. Create the Model

Create model file (e.g., `app/models/warehouse.py`):

```python
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from geoalchemy2 import Geometry
from app.db.base import Base

class Warehouse(Base):
    __tablename__ = "warehouses"

    id = Column(Integer, primary_key=True)
    code = Column(String, unique=True, nullable=False)
    name = Column(String, nullable=False)
    geojson_coordinates = Column(Geometry('POLYGON'), nullable=True)
    active = Column(Boolean, default=True)
    created_at = Column(DateTime, nullable=False)
```

### 2. Register Model in Base

Update `app/db/base.py` to import the new model:

```python
from sqlalchemy.orm import declarative_base

Base = declarative_base()

# Import models for Alembic autogenerate
from app.models.warehouse import Warehouse  # Add this line
```

### 3. Generate Migration

```bash
# Autogenerate migration from model changes
alembic revision --autogenerate -m "add warehouse model"
```

### 4. Review Generated Migration

Open the generated file in `alembic/versions/` and verify:

- Table names correct
- Column types correct
- Constraints included
- Indexes included (especially PostGIS spatial indexes)
- Foreign keys correct

**Manual additions often needed**:

```python
def upgrade():
    # Autogenerated table creation
    op.create_table('warehouses', ...)

    # MANUALLY ADD: Spatial index for geojson_coordinates
    op.execute('''
        CREATE INDEX idx_warehouses_geojson
        ON warehouses
        USING GIST (geojson_coordinates)
    ''')
```

### 5. Apply Migration

```bash
# Apply to database
alembic upgrade head

# Verify tables created
psql -d demeterai -c "\dt"
```

### 6. Test Rollback

```bash
# Test downgrade works
alembic downgrade -1

# Re-apply
alembic upgrade head
```

## Initial Migration: PostGIS Extension

The first migration (6f1b94ebef45) enables PostGIS:

```python
def upgrade() -> None:
    # Enable PostGIS extension
    op.execute('CREATE EXTENSION IF NOT EXISTS postgis')

    # Verify installation
    op.execute('SELECT PostGIS_Version()')

def downgrade() -> None:
    # Drop PostGIS (CASCADE drops dependent objects)
    op.execute('DROP EXTENSION IF EXISTS postgis CASCADE')
```

**Why PostGIS?**

- DemeterAI has 4-level geospatial hierarchy
- Stores GeoJSON coordinates (POLYGON, POINT)
- Enables spatial queries (ST_Contains, ST_Distance)
- Required for warehouse/storage area mapping

## Migration Best Practices

### 1. Always Review Autogenerate

Autogenerate is helpful but not perfect:

```bash
# Generate migration
alembic revision --autogenerate -m "description"

# ALWAYS review the generated file before applying
# Check: table names, types, constraints, indexes
```

### 2. Make Migrations Reversible

Every `upgrade()` should have a corresponding `downgrade()`:

```python
def upgrade():
    op.create_table('my_table', ...)

def downgrade():
    op.drop_table('my_table')
```

### 3. Test Upgrade/Downgrade Cycle

Before committing, test bidirectional migration:

```bash
alembic upgrade head    # Apply migration
alembic downgrade -1    # Rollback migration
alembic upgrade head    # Re-apply migration
```

### 4. Use Transactions

Alembic runs migrations in transactions by default. Complex migrations:

```python
def upgrade():
    # All operations in single transaction
    op.create_table(...)
    op.add_column(...)
    op.create_index(...)
    # If any fails, all rollback
```

### 5. Data Migrations

For data transformations, use `op.execute()`:

```python
def upgrade():
    # Schema change
    op.add_column('warehouses', sa.Column('region', sa.String()))

    # Data migration
    op.execute('''
        UPDATE warehouses
        SET region = 'north'
        WHERE latitude > 0
    ''')
```

### 6. PostGIS Indexes

Alembic doesn't auto-detect spatial indexes. Add manually:

```python
def upgrade():
    # Table creation (autogenerated)
    op.create_table('storage_areas', ...)

    # MANUAL: Add GIST index for geometry column
    op.execute('''
        CREATE INDEX idx_storage_areas_geojson
        ON storage_areas
        USING GIST (geojson_coordinates)
    ''')

def downgrade():
    op.drop_index('idx_storage_areas_geojson')
    op.drop_table('storage_areas')
```

## Troubleshooting

### Error: "Can't locate revision identified by 'head'"

**Cause**: No migrations applied yet

**Solution**:

```bash
# Check if any migrations exist
alembic history

# If migrations exist but not applied
alembic upgrade head
```

### Error: "Target database is not up to date"

**Cause**: Database schema doesn't match migration history

**Solution**:

```bash
# Check current revision
alembic current

# Show pending migrations
alembic history

# Apply missing migrations
alembic upgrade head
```

### Error: "Can't connect to database"

**Cause**: PostgreSQL not running or wrong credentials

**Solution**:

```bash
# Check PostgreSQL is running
sudo systemctl status postgresql

# Verify .env DATABASE_URL_SYNC is correct
cat .env | grep DATABASE_URL_SYNC

# Test connection manually
psql -h localhost -U demeter -d demeterai
```

### Error: "EXTENSION postgis does not exist"

**Cause**: Initial migration not applied

**Solution**:

```bash
# Apply initial migration
alembic upgrade head

# Verify PostGIS enabled
psql -d demeterai -c "SELECT PostGIS_Version();"
```

## Integration with Development Workflow

### Sprint 01: Model Creation (DB001-DB035)

For each model card:

1. Create SQLAlchemy model
2. Register in `app/db/base.py`
3. Generate migration: `alembic revision --autogenerate -m "add XXX model"`
4. Review and enhance migration
5. Apply: `alembic upgrade head`
6. Test: Model queries work
7. Commit: Model + migration together

### Sprint 05: Docker Integration (F012)

When Docker is set up:

- Migrations will run automatically on container startup
- Use `docker-compose up` to apply migrations
- Database state persisted in Docker volume

### Production Deployment

For production:

```bash
# 1. Generate SQL (don't apply directly)
alembic upgrade head --sql > migration.sql

# 2. Review SQL carefully

# 3. Apply during maintenance window
psql -d demeterai_prod -f migration.sql

# 4. Verify
alembic current
```

## References

- Alembic Documentation: https://alembic.sqlalchemy.org/
- SQLAlchemy 2.0: https://docs.sqlalchemy.org/en/20/
- PostGIS: https://postgis.net/documentation/
- DemeterAI Database Schema: `/engineering_plan/database/README.md`

---

**Setup completed**: 2025-10-13 (Card F007)
**Initial migration**: 6f1b94ebef45 (PostGIS extension)
**Next steps**: Create database models (DB001-DB035)
